@page "/reports/inventory"
@layout MainLayout
@using MauiApp2.Services
@using MauiApp2.Models
@using CategoryModel = MauiApp2.Models.Category
@using BrandModel = MauiApp2.Models.Brand
@using InventoryReportModel = MauiApp2.Services.InventoryReport
@using Microsoft.JSInterop
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IReportService ReportService
@inject ICategoryService CategoryService
@inject IBrandService BrandService
@inject IJSRuntime JSRuntime

<link href="css/inventory-transactions.css" rel="stylesheet" />
<link href="css/pagination.css" rel="stylesheet" />

@if (!CanAccessReports())
{
    <div class="dashboard-wrapper">
        <Sidebar />
        <div class="main-content">
            <div class="content-header">
                <h1>Access Denied</h1>
                <p>You do not have permission to access this page.</p>
                <p>Only Inventory Manager and Administrator roles can access Reports.</p>
            </div>
        </div>
    </div>
}
else
{
    <div class="dashboard-wrapper">
        <Sidebar />
        <div class="main-content">
            <div class="content-header">
                <h1>Inventory Report</h1>
            </div>

        <div class="inventory-section">
            <div class="product-table-container">
                <!-- Alert Messages -->
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-error">
                        <span class="alert-icon"><i class="fas fa-exclamation-triangle"></i></span>
                        <span>@errorMessage</span>
                        <button class="alert-close" @onclick="ClearError"><i class="fas fa-times"></i></button>
                    </div>
                }

                @if (isLoading)
                {
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <span>Loading inventory data...</span>
                    </div>
                }

                <!-- Filters -->
                <div class="filter-section">
                    <div class="filter-group">
                        <label>Category</label>
                        <div class="select-wrapper">
                            <select class="form-control" @bind="selectedCategoryId" @bind:event="onchange">
                                <option value="0">All Categories</option>
                                @foreach (var category in availableCategories)
                                {
                                    <option value="@category.category_id">@category.category_name</option>
                                }
                            </select>
                            <i class="fas fa-chevron-down select-icon"></i>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Brand</label>
                        <div class="select-wrapper">
                            <select class="form-control" @bind="selectedBrandId" @bind:event="onchange">
                                <option value="0">All Brands</option>
                                @foreach (var brand in availableBrands)
                                {
                                    <option value="@brand.brand_id">@brand.brand_name</option>
                                }
                            </select>
                            <i class="fas fa-chevron-down select-icon"></i>
                        </div>
                    </div>

                    <div class="filter-actions">
                        <button class="btn-clear" @onclick="ClearDateFilters">
                            <i class="fas fa-times"></i>
                            <span>Clear Filters</span>
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                @if (isLoaded || reportData.Any())
                {
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-icon total-movements-icon">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">Total Products</div>
                                <div class="summary-value">@TotalProducts</div>
                                <div class="summary-count">All products</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon stock-in-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">Total Quantity</div>
                                <div class="summary-value">@TotalQuantity</div>
                                <div class="summary-count">Units in stock</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon stock-out-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">Total Stock Value</div>
                                <div class="summary-value">₱@TotalStockValue.ToString("N2")</div>
                                <div class="summary-count">Inventory worth</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon net-movement-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="summary-content">
                                <div class="summary-label">Low Stock Items</div>
                                <div class="summary-value @(LowStockItems > 0 ? "negative" : "")">@LowStockItems</div>
                                <div class="summary-count">Below threshold</div>
                            </div>
                        </div>
                    </div>
                }

                <div class="toolbar">
                    <div style="display: flex; gap: var(--spacing-md); align-items: center; flex-wrap: wrap;">
                        <button class="add-item-btn" @onclick="LoadReport" disabled="@isLoading">
                            <i class="fas @(isLoading ? "fa-spinner fa-spin" : "fa-search")"></i>
                            <span>@(isLoading ? "Generating..." : "Generate Report")</span>
                        </button>
                        <button class="add-item-btn" @onclick="ExportToPdf" disabled="@(!reportData.Any() || isLoading)" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);">
                            <i class="fas fa-file-pdf"></i>
                            <span>Export PDF</span>
                        </button>
                    </div>

                    @if (reportData.Any())
                    {
                        <div class="search-container">
                            <input type="text"
                                   class="search-input"
                                   placeholder="Search by product name, SKU, category, or brand..."
                                   value="@searchTerm"
                                   @oninput="OnSearchInput" />
                            <span class="search-icon"><i class="fas fa-search"></i></span>
                        </div>
                    }
                </div>

                <!-- Report Table -->
                <div class="table-wrapper">
                    @if (reportData.Any())
                    {
                        <table id="report-table" class="product-table">
                        <thead>
                            <tr>
                                <th class="sortable" @onclick='() => SortBy("ProductName")'>
                                    Product Name
                                    @if (sortColumn == "ProductName")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                                <th class="sortable" @onclick='() => SortBy("SKU")'>
                                    SKU
                                    @if (sortColumn == "SKU")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                                <th class="sortable" @onclick='() => SortBy("Category")'>
                                    Category
                                    @if (sortColumn == "Category")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                                <th class="sortable" @onclick='() => SortBy("Brand")'>
                                    Brand
                                    @if (sortColumn == "Brand")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                                <th class="sortable" @onclick='() => SortBy("Quantity")'>
                                    Quantity
                                    @if (sortColumn == "Quantity")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                                <th class="sortable" @onclick='() => SortBy("CostPrice")'>
                                    Cost Price
                                    @if (sortColumn == "CostPrice")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                                <th class="sortable" @onclick='() => SortBy("SellPrice")'>
                                    Sell Price
                                    @if (sortColumn == "SellPrice")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                                <th class="sortable" @onclick='() => SortBy("StockValue")'>
                                    Stock Value
                                    @if (sortColumn == "StockValue")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                                <th class="sortable" @onclick='() => SortBy("Status")'>
                                    Status
                                    @if (sortColumn == "Status")
                                    {
                                        <i class="fas fa-sort-@(sortDirection == "asc" ? "up" : "down")"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort sort-inactive"></i>
                                    }
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in PaginatedReportData)
                            {
                                <tr class="@(row.Quantity <= 5 ? "low-stock" : "")">
                                    <td>@row.ProductName</td>
                                    <td>@row.SKU</td>
                                    <td>@row.Category</td>
                                    <td>@row.Brand</td>
                                    <td>@row.Quantity</td>
                                    <td>₱@row.CostPrice.ToString("N2")</td>
                                    <td>₱@row.SellPrice.ToString("N2")</td>
                                    <td>₱@row.StockValue.ToString("N2")</td>
                                    <td>
                                        <span class="status-badge @(row.Status == "Active" ? "active" : "inactive")">
                                            @row.Status
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="4"><strong>Total</strong></td>
                                <td><strong>@FilteredReportData.Sum(r => r.Quantity)</strong></td>
                                <td colspan="2"></td>
                                <td><strong>₱@FilteredReportData.Sum(r => r.StockValue).ToString("N2")</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                        </table>
                    }
                    else if (isLoaded)
                    {
                        <table class="product-table">
                            <tbody>
                                <tr>
                                    <td colspan="9" class="empty-state-cell">
                                        <div class="empty-state">
                                            <i class="fas fa-boxes empty-state-icon"></i>
                                            <p class="empty-state-text">No inventory data found for the selected filters.</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <table class="product-table">
                            <tbody>
                                <tr>
                                    <td colspan="9" class="empty-state-cell">
                                        <div class="empty-state">
                                            <i class="fas fa-info-circle empty-state-icon"></i>
                                            <p class="empty-state-text">Click "Generate Report" to view inventory data.</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    }
                </div>

                <!-- Pagination -->
                @if (FilteredReportData.Any())
                {
                    <Pagination CurrentPage="@currentPage"
                                PageSize="@pageSize"
                                TotalItems="@FilteredReportData.Count()"
                                PageChanged="@OnPageChanged"
                                PageSizeChanged="@OnPageSizeChanged" />
                }
            </div>
        </div>
    </div>
    </div>
    }
}

@code {
    private int selectedCategoryId = 0;
    private int selectedBrandId = 0;
    private List<InventoryReportModel> reportData = new List<InventoryReportModel>();
    private List<CategoryModel> availableCategories = new List<CategoryModel>();
    private List<BrandModel> availableBrands = new List<BrandModel>();
    private string errorMessage = "";
    private bool isLoaded = false;
    private bool isLoading = false;
    
    // Search and Sort
    private string searchTerm = "";
    private string sortColumn = "ProductName";
    private string sortDirection = "asc";
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        if (!AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadCategoriesAndBrands();
    }

    private async Task LoadCategoriesAndBrands()
    {
        try
        {
            availableCategories = (await CategoryService.GetCategoriesAsync()).ToList();
            availableBrands = (await BrandService.GetBrandsAsync()).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading categories/brands: {ex.Message}";
        }
    }

    private async Task LoadReport()
    {
        try
        {
            errorMessage = "";
            isLoaded = false;
            isLoading = true;
            StateHasChanged();

            int? categoryId = selectedCategoryId > 0 ? selectedCategoryId : null;
            int? brandId = selectedBrandId > 0 ? selectedBrandId : null;

            reportData = await ReportService.GetInventoryReportAsync(categoryId, brandId);
            isLoaded = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading report: {ex.Message}";
            Console.WriteLine($"Error loading inventory report: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ExportToPdf()
    {
        if (!reportData.Any())
            return;

        try
        {
            // Generate report number
            var reportNumber = $"INV-{DateTime.Now:yyyyMMdd}-{DateTime.Now:HHmmss}";
            var generatedDate = DateTime.Now.ToString("dd.MM.yyyy");
            
            // Get filter information
            var categoryFilter = selectedCategoryId > 0 
                ? availableCategories.FirstOrDefault(c => c.category_id == selectedCategoryId)?.category_name ?? "All Categories"
                : "All Categories";
            var brandFilter = selectedBrandId > 0
                ? availableBrands.FirstOrDefault(b => b.brand_id == selectedBrandId)?.brand_name ?? "All Brands"
                : "All Brands";
            
            // Calculate summary metrics
            var totalProducts = TotalProducts;
            var totalQuantity = TotalQuantity;
            var totalStockValue = TotalStockValue;
            var lowStockItems = LowStockItems;
            
            // Convert all filtered report data to JSON for PDF export
            var allReportData = FilteredReportData.Select(r => new
            {
                ProductName = r.ProductName,
                SKU = r.SKU,
                Category = r.Category,
                Brand = r.Brand,
                Quantity = r.Quantity,
                CostPrice = r.CostPrice.ToString("N2"),
                SellPrice = r.SellPrice.ToString("N2"),
                StockValue = r.StockValue.ToString("N2"),
                Status = r.Status
            }).ToList();

            await JSRuntime.InvokeVoidAsync("pdfExport.exportInventoryReportToPdf", 
                "report-table",
                reportNumber,
                generatedDate,
                categoryFilter,
                brandFilter,
                totalProducts,
                totalQuantity,
                totalStockValue,
                lowStockItems,
                System.Text.Json.JsonSerializer.Serialize(allReportData),
                $"InventoryReport_{DateTime.Now:yyyyMMdd_HHmmss}.pdf");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error exporting PDF: {ex.Message}";
            Console.WriteLine($"Error exporting PDF: {ex}");
            StateHasChanged();
        }
    }

    private void ClearError()
    {
        errorMessage = "";
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        currentPage = 1;
        StateHasChanged();
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortDirection = sortDirection == "asc" ? "desc" : "asc";
        }
        else
        {
            sortColumn = column;
            sortDirection = "asc";
        }
        currentPage = 1;
        StateHasChanged();
    }

    private IEnumerable<InventoryReportModel> FilteredReportData
    {
        get
        {
            var filtered = reportData.AsEnumerable();

            if (!string.IsNullOrEmpty(searchTerm))
            {
                filtered = filtered.Where(r => 
                    r.ProductName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    r.SKU.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    r.Category.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    r.Brand.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            }

            // Sort
            switch (sortColumn)
            {
                case "ProductName":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.ProductName) 
                        : filtered.OrderByDescending(r => r.ProductName);
                    break;
                case "SKU":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.SKU) 
                        : filtered.OrderByDescending(r => r.SKU);
                    break;
                case "Category":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.Category) 
                        : filtered.OrderByDescending(r => r.Category);
                    break;
                case "Brand":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.Brand) 
                        : filtered.OrderByDescending(r => r.Brand);
                    break;
                case "Quantity":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.Quantity) 
                        : filtered.OrderByDescending(r => r.Quantity);
                    break;
                case "CostPrice":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.CostPrice) 
                        : filtered.OrderByDescending(r => r.CostPrice);
                    break;
                case "SellPrice":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.SellPrice) 
                        : filtered.OrderByDescending(r => r.SellPrice);
                    break;
                case "StockValue":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.StockValue) 
                        : filtered.OrderByDescending(r => r.StockValue);
                    break;
                case "Status":
                    filtered = sortDirection == "asc" 
                        ? filtered.OrderBy(r => r.Status) 
                        : filtered.OrderByDescending(r => r.Status);
                    break;
            }

            return filtered;
        }
    }

    private IEnumerable<InventoryReportModel> PaginatedReportData
    {
        get
        {
            var filtered = FilteredReportData.ToList();
            return filtered.Skip((currentPage - 1) * pageSize).Take(pageSize);
        }
    }

    private void OnPageChanged(int page)
    {
        currentPage = page;
        StateHasChanged();
    }

    private void OnPageSizeChanged(int newPageSize)
    {
        pageSize = newPageSize;
        currentPage = 1;
        StateHasChanged();
    }

    private void ClearDateFilters()
    {
        selectedCategoryId = 0;
        selectedBrandId = 0;
        currentPage = 1;
        StateHasChanged();
    }

    private bool HasActiveDateFilters()
    {
        return selectedCategoryId > 0 || selectedBrandId > 0;
    }

    // Summary card calculations
    private int TotalProducts
    {
        get
        {
            return FilteredReportData.Count();
        }
    }

    private int TotalQuantity
    {
        get
        {
            return FilteredReportData.Sum(r => r.Quantity);
        }
    }

    private decimal TotalStockValue
    {
        get
        {
            return FilteredReportData.Sum(r => r.StockValue);
        }
    }

    private int LowStockItems
    {
        get
        {
            return FilteredReportData.Count(r => r.Quantity <= 5);
        }
    }

    // Check if user can access reports
    // Only Inventory Manager and Administrator can access
    private bool CanAccessReports()
    {
        if (AuthService == null)
            return false;

        string userRole = (AuthService.CurrentUserRoleName ?? "").Trim();
        return userRole.Equals("Inventory Manager", StringComparison.OrdinalIgnoreCase) ||
               userRole.Equals("Administrator", StringComparison.OrdinalIgnoreCase);
    }
}

